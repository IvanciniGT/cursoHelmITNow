apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: {{ .Release.Name }}-master
    labels: 
        app: {{ .Release.Name }}-es
        tipo-nodo: master
spec:
    replicas: {{ .Values.master.deploy.replicas }}
    selector:
      matchLabels:
        app: {{ .Release.Name }}-es
        tipo-nodo: master
        
    serviceName: {{ include "elasticsearch.nombre-servicio-maestro" $ }}
    
    template: # Plantilla del POD 
        metadata:
            labels: 
                app: {{ .Release.Name }}-es
                tipo-nodo: master
        spec:
          {{- with .Values.master.deploy.affinities }}
          affinity: 
            {{- toYaml . | nindent 12 }}
          {{- end }}
          
          {{- with .Values.master.deploy.tolerations }}
          tolerations: 
            {{- toYaml . | nindent 12 }}
          {{- end }}
      
          {{- with .Values.master.deploy.extraLabels }}
          extraLabels: 
            {{- toYaml . | nindent 12 }}
          {{- end }}
          
          containers:
            - name: elasticSearch
              #image: docker.elastic.co/elasticsearch/elasticsearch:7.11.0
              image: {{ include "elasticsearch.imagen-elasticsearch" $ }}
                                                                    # Este $ no nos vale.... y la vamos a tener que liar
              {{- with .Values.master.deploy.resources }}
              resources: 
                {{- toYaml . | nindent 18 }}
              {{- end }}
              ports:
                - containerPort: {{ .Values.elastic.image.ports.private }}
                - containerPort: {{ .Values.elastic.image.ports.public }}
              envFrom:
                - configMapRef:
                    name: {{ include "elasticsearch.nombre-configmap-general" $ }}
                - configMapRef: 
                    name: {{ include "elasticsearch.nombre-configmap-default" $ }}
                - configMapRef: 
                    name: {{ .Release.Name}}-master-es
              env:
                - name: node.name
                  valueFrom: 
                    fieldRef:
                       fieldPath: metadata.name
                - name: node.master
                  value: "true"
                - name: ELASTIC_PASSWORD
                  valueFrom:
                        secretKeyRef:
                            name: {{ include "elasticsearch.nombre-secret-general" $ }}
                            key: elastic-user-password
                {{- with .Values.master.deploy.extraEnv }}
                  {{- toYaml . | nindent 16 }}
                {{- end }}
              volumeMounts:
                - name: datos-elasticsearch
                  mountPath: /usr/share/elasticsearch/data
                  
    volumeClaimTemplates:
        -   metadata:
                name: datos-elasticsearch
            spec:
                storageClassName: {{ .Values.elastic.persistence.storageClassName }}
                resources:
                    requests:
                        storage: {{ .Values.elastic.persistence.capacity }}
                {{- with .Values.elastic.persistence.accessModes }}
                accessModes: 
                  {{- toYaml . | nindent 18 }}
                {{- end }}
